version: 2.1

description: |
  Orb for building a Docker image

commands:
  build:
    parameters:
      dockeruser:
        type: string
      dockerrepo:
        type: string
      herokurepo:
        type: string
      herokuproctype:
        default: "web"
        type: string

    steps:
      - checkout

      - run:
         name: Build Docker image
         command: docker build -t hyperbotauthor/hyperbot .
      
      - run:
          name: Push to DockerHub
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login --username << parameters.dockeruser >> --password-stdin
            docker push hyperbotauthor/hyperbot
      - run:
          name: Push to Heroku
          command: |
            echo "$HEROKU_API_KEY" | docker login --username=_ registry.heroku.com --password-stdin
            docker tag << parameters.dockeruser >>/<< parameters.dockerrepo >> registry.heroku.com/<< parameters.herokurepo >>/<< parameters.herokuproctype >>
            docker push registry.heroku.com/hyperbotauthor/<< parameters.herokurepo >>/<< parameters.herokuproctype >>